<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Collab</title>
    <!-- jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function(){
            var current_user = null;
            var selected_user = "";
            // get user if logged in
            $.get("/api/current_user", function(response){
                 current_user = response["user"]
                 if (current_user){
                    $("#not-auth").css("display", "none");
                    $("#right_sidebar #cur_user").text(current_user);
                    $("#auth").css("display", "inline-block");
                    // get list of online users
                    $.get("/api/online_users", function(response){
                        var users_list = response["users"]
                        if (!jQuery.isEmptyObject(users_list)){
                            var parent = $("#left_sidebar ul");
                            $.each(users_list, function(key, value){
                                if (current_user != value){
                                    child = "<li> <a>"+value+"</a> </li>";
                                    parent.append(child);
                                }
                            });
                        }
                    });
                 }
            });
            // change from one public chat to personal
            $(document).on("click", "ul a", function(){
               var user = $(this).text();
               $("#auth h3 span").text(user);
               selected_user = user;
            });
            // change from personal to public chat
            $(document).on("click", "#public_chat", function(){
                var text = $("#auth h3 span").text();
                if (text != "public chat"){
                    $("#auth h3 span").text("public chat");
                    selected_user = "";
                }
            });
            // create websocket
            var socket = new WebSocket("ws://localhost:8000/api/ws");
            socket.onmessage = function(event) {
                var parent = $("#messages");
                var data = event.data;
                var index = data.indexOf(":");
                var sender = data.substring(0, index);
                if (sender == current_user)
                    sender = "you";
                sender = sender + ":"
                var message = data.substring(index + 1, data.length);
                var content = "<p><strong>"+sender+"</strong><br><span>"+message+"</span></p>";
                parent.append(content);
            };
            // send message with websocket
            function sendMessage() {
                var input = document.getElementById("messageText");
                data = {
                    "message": input.value,
                    "client": selected_user
                };
                socket.send(JSON.stringify(data));
                input.value = '';
            }
            // submit form for chatting
            $("#chat-form").on("submit", function(e){
                e.preventDefault();
                //var socket = createSocket();
                sendMessage();
            });
            // logout the user
            $("#logout").on("click", function(){
                $.post("/api/logout", function(response){
                    window.location.href = "/"
                });
            });
        });
    </script>
</head>
<body>
    <div style="text-align: center;">
        <div id="not-auth">
             <h4>Please login to your account or create one for starting a conversion.</h4>
            <a href="/login" style="background: rgb(230, 230, 230); padding: 10px;"> Login </a> &nbsp; <a href="/register" style="background: rgb(230, 230, 230); padding: 10px;"> Register </a>
        </div>
        <div id="auth" style="display: none;">
            <strong id="err"></strong><br>
            <div style="position: absolute; left: 50%; transform: translateX(-50%);">
                <h3> <span>public chat</span> <button id="logout" style="background: rgb(230, 230, 230); margin-left: 10px; padding: 5px;"> Logout </button></h3>
                <form id="chat-form">
                    <input type="text" id="messageText" autocomplete="off"/>
                    <button type="submit">Send</button>
                </form>
                <div id="messages" style="text-align: left;"></div>
            </div>
            <div id="left_sidebar" style="position: absolute; left: 5%; top: 10%;">
                <strong> online users </strong><br>
                <ul>
                </ul>
            </div>
            <div id="right_sidebar" style="position: absolute; left: 85%; top: 10%;">
                <strong> profile </strong>
                <p id="cur_user"></p>
                <strong> options </strong>
                <p id="public_chat"> public chat </p>
            </div>
        </div>
    </div>
</body>
</html>